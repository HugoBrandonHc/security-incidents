<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Incidentes</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>Registrar Incidente</h1>
    <form id="form-incidente">
        <label for="id_incidente">ID Incidente:</label>
        <input type="text" id="id_incidente" name="id_incidente" required><br><br>

        <label for="descripcion">Descripción:</label>
        <textarea id="descripcion" name="descripcion" required></textarea><br><br>

        <label for="estado">Estado:</label>
        <select id="estado" name="estado" required>
            <option value="Abierto">Abierto</option>
            <option value="Cerrado">Cerrado</option>
        </select><br><br>

        <label for="prioridad">Prioridad:</label>
        <select id="prioridad" name="prioridad" required>
            <option value="Alta">Alta</option>
            <option value="Media">Media</option>
            <option value="Baja">Baja</option>
        </select><br><br>

        <label for="archivo">Archivo PDF:</label>
        <input type="file" id="archivo" name="archivo" accept="application/pdf" required><br><br>

        <button type="submit">Registrar</button>
    </form>

    <p id="resultado"></p>

    <h2>Archivos Subidos</h2>
    <table id="tabla-archivos">
        <thead>
            <tr>
                <th>ID Incidente</th>
                <th>Descripción</th>
                <th>Estado</th>
                <th>Prioridad</th>
                <th>Archivo</th>
            </tr>
        </thead>
        <tbody>
            <!-- Las filas se llenarán dinámicamente -->
        </tbody>
    </table>

    <script>
        document.getElementById("form-incidente").addEventListener("submit", async function(event) {
            event.preventDefault();

            const id_incidente = document.getElementById("id_incidente").value;
            const descripcion = document.getElementById("descripcion").value;
            const estado = document.getElementById("estado").value;
            const prioridad = document.getElementById("prioridad").value;
            const archivoInput = document.getElementById("archivo").files[0];

            if (!archivoInput) {
                document.getElementById("resultado").innerText = "Por favor, selecciona un archivo.";
                return;
            }

            if (archivoInput.size > 5 * 1024 * 1024) {
                document.getElementById("resultado").innerText = "El archivo debe ser menor a 5 MB.";
                return;
            }

            const reader = new FileReader();
            reader.onload = async function() {
                const archivoBase64 = reader.result.split(",")[1];

                const data = {
                    id_incidente,
                    descripcion,
                    estado,
                    fecha_creacion: new Date().toISOString().split("T")[0],
                    prioridad,
                    archivo: archivoBase64
                };

                try {
                    const response = await fetch("https://bf9tv4oh0m.execute-api.us-east-2.amazonaws.com/produccion/incidentes", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();
                    document.getElementById("resultado").style.color = "green";
                    document.getElementById("resultado").innerText = result.message;
                    cargarArchivos(); // Actualiza la tabla tras registrar un incidente
                } catch (error) {
                    console.error(error);
                    document.getElementById("resultado").style.color = "red";
                    document.getElementById("resultado").innerText = "Error al registrar el incidente.";
                }
            };

            reader.readAsDataURL(archivoInput);
        });

        async function cargarArchivos() {
            try {
                const response = await fetch("https://bf9tv4oh0m.execute-api.us-east-2.amazonaws.com/produccion/listar"); // Nuevo endpoint para listar incidentes
                const datos = await response.json();

                const tabla = document.getElementById("tabla-archivos").querySelector("tbody");
                tabla.innerHTML = ""; // Limpiar tabla antes de llenarla

                datos.forEach(item => {
                    const fila = document.createElement("tr");

                    fila.innerHTML = `
                        <td>${item.id_incidente}</td>
                        <td>${item.descripcion}</td>
                        <td>${item.estado}</td>
                        <td>${item.prioridad}</td>
                        <td><a href="https://incidentes-seguridad-hugo.s3.us-east-2.amazonaws.com/pdf/${item.id_incidente}.pdf" target="_blank">Ver Archivo</a></td>
                    `;
                    tabla.appendChild(fila);
                });
            } catch (error) {
                console.error("Error al cargar los archivos:", error);
            }
        }

        document.addEventListener("DOMContentLoaded", cargarArchivos);
    </script>
</body>
</html>
